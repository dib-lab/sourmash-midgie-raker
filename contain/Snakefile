MAGS, = glob_wildcards('picklists/{mag}.topN.pl.csv')

GTDB_ZIP = '/group/ctbrowngrp5/sourmash-db.new/gtdb-rs226/gtdb-rs226-k31.dna.zip'

print(f'found {len(MAGS)} MAGs')

METAGS=[
    "SRR11125249",
    "SRR12795785",
    "SRR15057925",
    "SRR15057930",
    "SRR5241537",
]

##  ./make-top-picklist.py ../min-set-cov/sketches.x.gtdb.fastgather.csv

rule all:
    input:
        expand('results/{ident}.topN.manysearch.csv', ident=MAGS)

rule check:
    input:
        'picklists/{ident}.topN.pl.csv',
    output:
        'manifests/{ident}.topN.mf.csv',
    shell: """
        sourmash sig check -m {output} -F csv --picklist {input}:ident:ident \
             ../rename/bin-sketches.renamed.sig.zip {GTDB_ZIP} \
             -k 31 --abspath        
    """

rule collect_metags:
    input:
        expand('../explain/metags/{name}.trim.sig.zip', name=METAGS)
    output:
        'metags.mf.csv',
    shell:
        "sourmash sig collect {input} -o {output} -F csv --abspath"

rule manysearch:
    input:
        query_mf='manifests/{ident}.topN.mf.csv',
        metags='metags.mf.csv',
    output:
        'results/{ident}.topN.manysearch.csv',
    threads: 4
    shell: """
        sourmash scripts manysearch -c {threads} -t 0 \
           {input.query_mf} {input.metags} -o {output}
    """
